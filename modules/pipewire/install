#!/usr/bin/env -S sh -e

cmd sudo install -D -m 644 "$(writetext <<'EOF'
@audio - rtprio 98
EOF
)" /etc/security/limits.d/20-rt-audio.conf

cmd install -D -m 644 "$(writetext <<EOF
context.properties = {
	default.clock.rate = 48000
	default.clock.allowed-rates = [ 48000 ]
	default.clock.min-quantum = 512
	default.clock.quantum = 1024
	default.clock.max-quantum = 2048
	default.clock.quantum-limit = 2048
}
EOF
)" ~/.config/pipewire/pipewire.conf.d/crackling-fix.conf
cmd install -D -m 644 "$(writetext <<EOF
pulse.properties = {
	pulse.min.req = 1024/48000
	pulse.min.frag = 1024/48000
	pulse.min.quantum = 1024/48000
	pulse.default.req = 2048/48000
}
EOF
)" ~/.config/pipewire/pipewire-pulse.conf.d/crackling-fix.conf
cmd install -D -m 644 "$(writetext <<EOF
jack.properties = {
	node.latency = 1024/48000
	node.quantum = 1024/48000
}
EOF
)" ~/.config/pipewire/jack.conf.d/crackling-fix.conf

# https://github.com/CachyOS/CachyOS-Settings/blob/8ac073c3a528f458d58d803775c399d7b845b2c6/usr/lib/modprobe.d/20-audio-pm.conf
cmd sudo install -D -m 644 "$(writetext <<EOF
options snd_hda_intel power_save=0
EOF
)" /etc/modprobe.d/audio-pm.conf
# https://github.com/CachyOS/CachyOS-Settings/blob/8ac073c3a528f458d58d803775c399d7b845b2c6/usr/lib/udev/rules.d/20-audio-pm.rules
cmd sudo install -D -m 644 "$(writetext << 'EOF'
SUBSYSTEM=="power_supply", ENV{POWER_SUPPLY_ONLINE}=="0", TEST=="/sys/module/snd_hda_intel", \
    RUN+="/bin/sh -c 'echo $$(cat /run/udev/snd-hda-intel-powersave 2>/dev/null || \
        echo 10) > /sys/module/snd_hda_intel/parameters/power_save'"

SUBSYSTEM=="power_supply", ENV{POWER_SUPPLY_ONLINE}=="1", TEST=="/sys/module/snd_hda_intel", \
    RUN+="/bin/sh -c '[[ $$(cat /sys/module/snd_hda_intel/parameters/power_save) != 0 ]] && \
        echo $$(cat /sys/module/snd_hda_intel/parameters/power_save) > /run/udev/snd-hda-intel-powersave; \
        echo 0 > /sys/module/snd_hda_intel/parameters/power_save'"
EOF
)" /etc/udev/rules.d/20-audio-pm.rules


cmd install -D -m 644 "$(writetext <<EOF
monitor.alsa.rules = [
  {
    matches = [
      {
        # Matches all sources
        node.name = "~alsa_input.*"
      },
      {
        # Matches all sinks
        node.name = "~alsa_output.*"
      }
    ]
    actions = {
      update-props = {
        session.suspend-timeout-seconds = 0
      }
    }
  }
]
# bluetooth devices
monitor.bluez.rules = [
  {
    matches = [
      {
        # Matches all sources
        node.name = "~bluez_input.*"
      },
      {
        # Matches all sinks
        node.name = "~bluez_output.*"
      }
    ]
    actions = {
      update-props = {
        session.suspend-timeout-seconds = 0
      }
    }
  }
]
EOF
)" ~/.config/wireplumber/wireplumber.conf.d/disable-suspension.conf
